<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>user</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body>
<h1>User CSV 파일 업로드 후 다운로드</h1>

<input type="file" id="csvUpload" accept=".csv">
<button id="downloadCsv">CSV 다운로드</button>

<script>
    $('#downloadCsv').on('click', function () {
        const fileInput = $('#csvUpload')[0];
        const file = fileInput.files[0];

        if (!file) {
            alert("CSV 파일을 먼저 업로드해주세요.");
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        $.ajax({
            url: '/users/upload/csv',
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            success: function (data) {
                if (Array.isArray(data) && data.length) {
                    const csv = convertToCsv(data);
                    downloadCsvWithBom(csv, 'user_formatted.csv');
                } else {
                    alert("CSV 변환 실패: 반환된 데이터가 유효하지 않습니다.");
                }
            },
            error: function (xhr, status, error) {
                alert("파일 업로드 또는 변환 실패: " + error);
            }
        });
    });

    function convertToCsv(data) {
        const headers = Object.keys(data[0]).join(',');
        const rows = data.map(obj =>
            Object.values(obj).map(val => `"${String(val).replace(/"/g, '""')}"`).join(',')
        );
        return [headers, ...rows].join('\r\n');
    }

    function downloadCsvWithBom(csvData, fileName) {
        const BOM = new Uint8Array([0xEF, 0xBB, 0xBF]);
        const csvBytes = new TextEncoder().encode(csvData);
        const blob = new Blob([BOM, csvBytes], { type: 'text/csv' });

        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
</body>
</html>
